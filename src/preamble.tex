%========================================
% preamble.tex — Preâmbulo unificado
% Livro: Introdução à Assimilação de Dados
% Autor: João Gerd Zell de Mattos
%========================================

%----------------------------
% Codificação, língua, fonte
%----------------------------
\usepackage[utf8]{inputenc}   % entrada UTF-8
\usepackage[T1]{fontenc}      % saída com acentuação correta
\usepackage[brazil]{babel}    % hifenização/nomes em pt-BR
\usepackage{lmodern}          % fonte Latin Modern
\usepackage{microtype}        % microtipografia (melhora a legibilidade)

%----------------------------
% Página e tipografia
%----------------------------
\usepackage{geometry}         % margens e formato de página
\geometry{a4paper, margin=2.5cm}
\usepackage{setspace}         % espaçamento entre linhas
\onehalfspacing
\usepackage{parskip}          % parágrafo com espaço em vez de indentação

%----------------------------
% Cores e hyperlinks
%----------------------------
\usepackage{xcolor}
\definecolor{primary}{RGB}{20, 92, 160}     % azul científico
\definecolor{secondary}{RGB}{0, 134, 114}   % verde água
\definecolor{accent}{RGB}{180, 60, 60}      % vermelho suave
\definecolor{textgray}{gray}{0.15}
% cores adicionais harmônicas
\definecolor{neutral}{gray}{0.25}           % cinza neutro
\definecolor{violet}{RGB}{110, 75, 160}     % violeta acadêmico
\definecolor{teal}{RGB}{30, 140, 140}       % verde-azulado elegante
\definecolor{orange}{RGB}{230,140, 40}      % laranja para observações
\color{textgray}

\usepackage{hyperref}                   % hyperlinks no PDF
\hypersetup{
  colorlinks=true,
  linkcolor=primary,
  citecolor=secondary,
  urlcolor=primary,
  pdfauthor={João Gerd Zell de Mattos},
  pdftitle={Introdução à Assimilação de Dados},
  pdfcreator={LaTeX},
  pdfsubject={Assimilação de Dados},
  pdfkeywords={assimilação de dados, var, enkf, híbrido, previsão numérica}
}
\usepackage{bookmark}                   % melhora marcadores do PDF (carregar DEPOIS de hyperref)

% cotações tipográficas — recomendado quando usar biblatex/estilo autor-ano
\usepackage{csquotes}

%----------------------------
% Matemática e SI
%----------------------------
\usepackage{amsmath,amssymb,mathtools} % matemática base
\usepackage{bm}                        % negrito em símbolos (vetores/matrizes)
\usepackage{physics}                   % notação conveniente (derivadas, etc.)
\usepackage{siunitx}                   % unidades SI e números
\sisetup{
  detect-all,
  per-mode=symbol,
  separate-uncertainty=true,
  exponent-product=\cdot,
  output-decimal-marker={,}  % pt-BR
}

% Operadores úteis
\DeclareMathOperator*{\argmin}{arg\,min}
\DeclareMathOperator*{\argmax}{arg\,max}

%----------------------------
% Figuras, tabelas, legendas
%----------------------------
\usepackage{graphicx}       % inclusão de figuras
\usepackage{booktabs}       % tabelas bonitas (\toprule, \midrule, \bottomrule)
\usepackage{caption}        % personalização de legendas
\usepackage{subcaption}     % subfiguras
\captionsetup{labelfont=bf}

%----------------------------
% TikZ / PGFPlots (figuras 100% LaTeX)
%----------------------------
\usepackage{tikz}
\usetikzlibrary{
  arrows.meta,positioning,calc,fit,
  decorations.pathmorphing,
  shapes.geometric,
  shadows, fadings
}
\tikzset{
  >={Stealth[length=2.0mm]},
  box/.style   ={draw, rounded corners=4pt, inner sep=6pt, thick, fill=primary!5},
  flow/.style  ={->, thick},
  circ/.style  ={draw, circle, minimum size=9mm, thick, fill=secondary!10},
  note/.style  ={draw, rounded corners=3pt, inner sep=5pt, dashed, color=secondary},
}

\usepackage{pgfplots}       % gráficos de dados
\pgfplotsset{compat=1.18}   % define compatibilidade estável do pgfplots

% (Opcional) macros próprias para setas em arco — carregar somente se for usado globalmente
\input{figures/arcarrow.tex}

%----------------------------
% Glossário e índice
%----------------------------
\usepackage[acronym,shortcuts,toc]{glossaries} % acrônimos + entrada no sumário
% Observação: \makeglossaries e \input{glossary} ficam no main.tex
\usepackage{makeidx}        % índice remissivo (\makeindex no main.tex)

%----------------------------
% Bibliografia (biblatex)
%----------------------------
% Mantém o carregamento aqui; o \addbibresource{...} fica no main.tex.
\usepackage[backend=biber,style=authoryear,maxbibnames=10,uniquename=false,natbib=true]{biblatex}

%----------------------------
% Estilo de títulos / epígrafe / listas
%----------------------------
\usepackage{titlesec}       % personalização de títulos (\chapter, \section, ...)
\usepackage{epigraph}       % epígrafes elegantes no início de capítulos
\setlength{\epigraphwidth}{0.7\textwidth}
\setlength{\epigraphrule}{0pt}

\usepackage{enumitem}       % listas com controle de espaçamento/labels
\setlist{itemsep=2pt, topsep=4pt}

%----------------------------
% Referências “inteligentes”
%----------------------------
\usepackage[nameinlink,noabbrev]{cleveref}
% Uso: \cref{fig:exemplo}, \Cref{eq:custo}, etc.

%----------------------------
% Listagens de código
%----------------------------
\usepackage{listings}
\lstdefinestyle{code}{
  basicstyle=\ttfamily\small,
  numbers=left,
  numberstyle=\tiny,
  stepnumber=1,
  numbersep=6pt,
  showstringspaces=false,
  breaklines=true,
  frame=single,
  rulecolor=\color{black!20},
  keywordstyle=\color{primary}\bfseries,
  commentstyle=\color{secondary!80!black}\itshape,
  stringstyle=\color{accent!90!black},
  tabsize=2
}
\lstset{style=code}

%======================================================
% CAIXAS EDITORIAIS UNIFICADAS (tcolorbox)
%======================================================
\usepackage[most]{tcolorbox}
\usepackage{fontawesome5}

\tcbset{
  enhanced, sharp corners=downhill, arc=2pt, boxsep=3pt,
  left=6pt, right=6pt, top=6pt, bottom=6pt, breakable
}

% =============== FABRICA DE CAIXAS (macro genérica) ===============
% Uso: \MakeBoxEnv{nome}{Titulo}{corBase}{icone}
\newcommand{\MakeBoxEnv}[4]{%
  % #1 = nome do ambiente (sem acento), ex: definicao
  % #2 = título (pode ter acento),    ex: Definição
  % #3 = cor base,                    ex: primary
  % #4 = ícone (fontawesome),         ex: \faBook
  \newtcolorbox{#1}[1][]{
    enhanced,
    colback=#3!6,                   % fundo suave
    colframe=#3!80!black,           % borda
    colbacktitle=#3!80!black,       % barra superior
    coltitle=white,                 % cor do título
    title={#4\ \textbf{#2}},        % título + ícone
    fonttitle=\bfseries\sffamily,   % estilo do título
    left=6pt, right=6pt, top=6pt, bottom=6pt,
    attach boxed title to top left={yshift=-2mm, xshift=2mm},
    boxed title style={
      sharp corners,
      rounded corners=northwest,
      rounded corners=northeast,
      boxrule=0pt,
      colframe=#3!80!black,
      colback=#3!80!black,
    },
    drop shadow,                    % sombra leve
    #1                              % opções extras
  }%
}

% ================== CAIXAS EDITORIAIS ==================
% já tens: definicao (mantém para coerência)
\MakeBoxEnv{definicao}{Definição}{primary}{\faBook}

% pedido: destaque, nota, alerta, exemplo
\MakeBoxEnv{destaque}{Destaque}{primary}{\faHighlighter}
\MakeBoxEnv{nota}{Nota}{secondary}{\faStickyNote}
\MakeBoxEnv{alerta}{Atenção}{accent}{\faExclamationTriangle}
\MakeBoxEnv{exemplo}{Exemplo}{neutral}{\faFlask}

% extras úteis em livro
\MakeBoxEnv{observacao}{Observação}{orange}{\faInfoCircle}
\MakeBoxEnv{dica}{Dica}{teal}{\faLightbulb}
\MakeBoxEnv{exercicio}{Exercício}{violet}{\faDumbbell}
\MakeBoxEnv{prova}{Prova}{accent}{\faPenFancy} % para demonstrações matemáticas
\MakeBoxEnv{comentario}{Comentário}{neutral}{\faCommentDots}
\MakeBoxEnv{sintese}{Síntese}{violet}{\faProjectDiagram}
%----------------------------
% Teoremas e afins (pt-BR)
%----------------------------
\usepackage{amsthm}
\theoremstyle{plain}
\newtheorem{teorema}{Teorema}[chapter]
\newtheorem{proposicao}[teorema]{Proposição}
\newtheorem{lema}[teorema]{Lema}
\theoremstyle{definition}
\newtheorem{definicao}[teorema]{Definição}
\newtheorem{exercicio}[teorema]{Exercício}
\theoremstyle{remark}
\newtheorem{observacao}[teorema]{Observação}

%----------------------------
% Cabeçalho/Rodapé
%----------------------------
\usepackage{fancyhdr}
\pagestyle{fancy}
\fancyhf{}
\fancyhead[LE,RO]{\thepage}
\fancyhead[LO]{\nouppercase{\rightmark}}
\fancyhead[RE]{\nouppercase{\leftmark}}
\renewcommand{\headrulewidth}{0.4pt}

%----------------------------
% Toggle rascunho/final
%----------------------------
\newif\ifdraft
\draftfalse % mude para \drafttrue durante a escrita (marcações úteis abaixo)

\ifdraft
  \usepackage[inline]{showlabels} % mostra labels ao lado (debug)
  \renewcommand{\baselinestretch}{1.2}
\fi

%----------------------------
% Comandos úteis p/ Assimilação de Dados
%----------------------------
% Vetores e matrizes (em negrito)
\newcommand{\vect}[1]{\bm{#1}}
\newcommand{\mat}[1]{\bm{#1}}

% Estados e observações
\newcommand{\xb}{\vect{x}_b}     % background
\newcommand{\xa}{\vect{x}_a}     % análise
\newcommand{\xo}{\vect{x}}       % estado genérico
\newcommand{\yobs}{\vect{y}}     % observações

% Operadores e matrizes
\newcommand{\Hop}{\mat{H}}       % operador de observação
\newcommand{\Kmat}{\mat{K}}      % ganho de Kalman
\newcommand{\Bmat}{\mat{B}}      % covariância de background
\newcommand{\Rmat}{\mat{R}}      % covariância de observação
\newcommand{\Pmat}{\mat{P}}      % genérica (Ex.: erro de previsão)
\newcommand{\J}{\mathcal{J}}     % função custo
\newcommand{\grad}{\nabla}       % gradiente
\newcommand{\T}{^{\mathsf T}}    % transposta

% Variação incremental (x' etc.)
\newcommand{\dx}{\delta \vect{x}}
\newcommand{\dy}{\delta \vect{y}}

% Conveniências
\newcommand{\norm}[1]{\left\lVert #1 \right\rVert}
\newcommand{\abs}[1]{\left\lvert #1 \right\rvert}

% Numeração por capítulo
\numberwithin{equation}{chapter}
\numberwithin{figure}{chapter}
\numberwithin{table}{chapter}

